<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡è³‡æ–™æŠ“å–å·¥å…·</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: scale(1.02);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        #status {
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 8px;
            min-height: 100px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            color: #10b981;
            font-weight: bold;
        }
        .error {
            color: #ef4444;
            font-weight: bold;
        }
        .info {
            color: #3b82f6;
        }
        textarea {
            width: 100%;
            min-height: 200px;
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ å°è‚¡è³‡æ–™æŠ“å–å·¥å…·</h1>
        <p class="subtitle">ä¸€éµå¾è­‰äº¤æ‰€æŠ“å–å®Œæ•´ä¸Šå¸‚å…¬å¸æ¸…å–®</p>
        
        <button id="fetchBtn" onclick="fetchStocks()">é–‹å§‹æŠ“å–è³‡æ–™</button>
        <button id="downloadBtn" onclick="downloadJSON()" style="display:none;">ä¸‹è¼‰ stocks.json</button>
        
        <div id="status">ç­‰å¾…é–‹å§‹...</div>
        
        <textarea id="output" style="display:none;" readonly></textarea>
    </div>

    <script>
        let stocksData = [];

        async function fetchStocks() {
            const btn = document.getElementById('fetchBtn');
            const status = document.getElementById('status');
            const output = document.getElementById('output');
            const downloadBtn = document.getElementById('downloadBtn');
            
            btn.disabled = true;
            status.innerHTML = '<span class="info">æ­£åœ¨æŠ“å–ä¸Šå¸‚å…¬å¸è³‡æ–™...</span>';
            
            try {
                // ä½¿ç”¨ proxy æœå‹™æŠ“å– CSVï¼ˆå› ç‚ºç€è¦½å™¨ CORS é™åˆ¶ï¼‰
                const csvUrl = 'https://mopsfin.twse.com.tw/opendata/t187ap03_L.csv';
                
                status.innerHTML += '\n<span class="info">é€£æ¥ä¸­: ' + csvUrl + '</span>';
                
                const response = await fetch(csvUrl);
                const csvText = await response.text();
                
                status.innerHTML += '\n<span class="success">âœ“ CSV ä¸‹è¼‰å®Œæˆ</span>';
                status.innerHTML += '\n<span class="info">æ­£åœ¨è§£æè³‡æ–™...</span>';
                
                // è§£æ CSV
                const lines = csvText.split('\n');
                const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
                
                stocksData = [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    // ç°¡åŒ–çš„ CSV è§£æï¼ˆè™•ç†å¼•è™ŸåŒ…è£¹çš„æ¬„ä½ï¼‰
                    const matches = lines[i].match(/("([^"]*)"|[^,]+)/g);
                    if (!matches ||matches.length < 3) continue;
                    
                    const values = matches.map(v => v.replace(/^"|"$/g, '').trim());
                    
                    // æ‰¾åˆ°é—œéµæ¬„ä½çš„ç´¢å¼•
                    const idIndex = headers.indexOf('å…¬å¸ä»£è™Ÿ');
                    const nameIndex = headers.indexOf('å…¬å¸åç¨±');
                    const shortNameIndex = headers.indexOf('å…¬å¸ç°¡ç¨±');
                    const industryIndex = headers.indexOf('ç”¢æ¥­åˆ¥');
                    
                    if (idIndex >= 0 && values[idIndex]) {
                        stocksData.push({
                            id: values[idIndex],
                            name: values[nameIndex] || values[idIndex],
                            shortName: values[shortNameIndex] || values[nameIndex] || values[idIndex],
                            industry: values[industryIndex] || 'ä¸Šå¸‚',
                            market: 'ä¸Šå¸‚',
                            description: '',
                            keyMetric: ''
                        });
                    }
                }
                
                status.innerHTML += '\n<span class="success">âœ“ è§£æå®Œæˆï¼Œå…± ' + stocksData.length + ' å®¶å…¬å¸</span>';
                
                // é¡¯ç¤º JSON
                const jsonStr = JSON.stringify(stocksData, null, 2);
                output.value = jsonStr;
                output.style.display = 'block';
                downloadBtn.style.display = 'block';
                
                status.innerHTML += '\n<span class="success">âœ“ å®Œæˆï¼å¯ä»¥ä¸‹è¼‰äº†</span>';
                
            } catch (err) {
                status.innerHTML += '\n<span class="error">âœ— éŒ¯èª¤: ' + err.message + '</span>';
                status.innerHTML += '\n\n<span class="info">æç¤ºï¼šç”±æ–¼ç€è¦½å™¨å®‰å…¨é™åˆ¶ï¼Œè«‹ç›´æ¥ä½¿ç”¨å·²æº–å‚™å¥½çš„ç¯„ä¾‹è³‡æ–™ã€‚</span>';
            } finally {
                btn.disabled = false;
            }
        }

        function downloadJSON() {
            const json = JSON.stringify(stocksData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'stocks.json';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
